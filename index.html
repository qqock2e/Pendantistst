<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뽑기 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .glow-button {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .glow-button:hover, .glow-button:active {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
            transform: translateY(-2px);
        }
        .currency-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .gacha-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .gacha-button:hover, .gacha-button:active {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }
        .point-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* 등급별 배경색 */
        .grade-common {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
        }
        .grade-rare {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }
        .grade-epic {
            background: linear-gradient(135deg, #9775fa 0%, #845ef7 100%);
            color: white;
        }
        .grade-legendary {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #495057;
        }
        .grade-unique {
            background: linear-gradient(45deg, #ff6b6b 0%, #feca57 16.66%, #48dbfb 33.33%, #0abde3 50%, #ff9ff3 66.66%, #54a0ff 83.33%, #5f27cd 100%);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
            color: white;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 모바일 최적화 */
        @media (max-width: 640px) {
            .currency-card {
                padding: 1rem;
                min-width: 120px;
            }
            .currency-card .text-3xl {
                font-size: 1.5rem;
            }
            .point-button {
                padding: 1rem 2rem;
                font-size: 1rem;
            }
            .gacha-button {
                padding: 1.25rem 2.5rem;
                font-size: 1.125rem;
            }
        }
        
        @media (max-width: 480px) {
            .currency-card {
                padding: 0.75rem;
                min-width: 100px;
            }
            .currency-card .text-3xl {
                font-size: 1.25rem;
            }
            .point-button {
                padding: 0.875rem 1.5rem;
                font-size: 0.875rem;
            }
            .gacha-button {
                padding: 1rem 2rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex flex-col items-center justify-center p-4">
    
    <!-- 메인 UI 영역 -->
    <div id="mainUI" class="transition-opacity duration-500">
        <!-- 재화 표시 영역 -->
        <div class="flex gap-4 sm:gap-6 mb-8 sm:mb-12">
            <!-- 포인트 -->
            <div class="currency-card rounded-2xl p-6 text-center text-white shadow-2xl">
                <div class="text-xs sm:text-sm font-medium opacity-80 mb-2">포인트</div>
                <div id="points" class="text-3xl font-bold">0</div>
            </div>
            
            <!-- 프리즘 -->
            <div class="currency-card rounded-2xl p-6 text-center text-white shadow-2xl">
                <div class="text-xs sm:text-sm font-medium opacity-80 mb-2">프리즘</div>
                <div id="prisms" class="text-3xl font-bold">0</div>
            </div>
        </div>

        <!-- 게임 버튼 영역 -->
        <div class="flex flex-col items-center gap-4 sm:gap-6">
            <!-- 상단 버튼들 -->
            <div class="flex gap-4 items-center">
                <!-- 포인트 획득 버튼 -->
                <button id="earnPointsBtn" class="point-button glow-button px-8 py-3 rounded-full text-white font-bold text-lg shadow-2xl touch-manipulation">
                    ✨ 포인트 획득 ✨
                </button>
                
                <!-- 인벤토리 버튼 -->
                <button id="inventoryBtn" class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 px-8 py-3 rounded-full text-white font-bold text-lg shadow-2xl touch-manipulation transition-all duration-300">
                    🎒 인벤토리
                </button>
                
                <!-- 설정 버튼 -->
                <button id="settingsBtn" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 px-8 py-3 rounded-full text-white font-bold text-lg shadow-2xl touch-manipulation transition-all duration-300">
                    ⚙️ 설정
                </button>
            </div>
            
            <!-- 상점 버튼 -->
            <button id="shopBtn" class="gacha-button px-16 py-5 rounded-full text-white font-bold text-2xl shadow-2xl touch-manipulation">
                🏪 상점 🏪
            </button>
            
            <!-- 장착된 보석 표시 -->
            <div id="equippedGemDisplay" class="mt-4 bg-white bg-opacity-10 rounded-xl p-4 text-center text-white opacity-0 transition-all duration-300">
                <div class="text-sm opacity-80 mb-2">장착된 보석</div>
                <div id="equippedGemIcon" class="text-3xl mb-2">💎</div>
                <div id="equippedGemName" class="font-bold mb-1">보석 이름</div>
                <div id="equippedGemStats" class="text-sm opacity-80">코러스 +1</div>
            </div>
        </div>

        <!-- 결과 메시지 -->
        <div id="message" class="mt-6 sm:mt-8 text-center text-white font-medium text-base sm:text-lg opacity-0 transition-opacity duration-300 px-4"></div>
    </div>

    <!-- 뽑기 모션 화면 -->
    <div id="gachaScreen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-500">
        <div class="text-center">
            <!-- 원석 이미지 (나중에 실제 이미지로 교체 가능) -->
            <div id="gemstone" class="w-32 h-32 sm:w-40 sm:h-40 bg-gray-300 rounded-lg mx-auto mb-6 cursor-pointer transform transition-all duration-300 hover:scale-110 shadow-2xl flex items-center justify-center text-4xl">
                💎
            </div>
            <p id="gachaText" class="text-white text-lg sm:text-xl font-medium">원석을 클릭하세요!</p>
        </div>
    </div>

    <!-- 등급 공개 화면 -->
    <div id="revealScreen" class="fixed inset-0 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-1000">
        <div class="text-center">
            <div id="gradeText" class="text-6xl sm:text-8xl font-bold mb-4 drop-shadow-2xl"></div>
            <p id="revealMessage" class="text-white text-xl sm:text-2xl font-medium mb-8">등급이 공개되었습니다!</p>
            <button id="continueBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-8 py-3 rounded-full text-white font-bold text-lg transition-all duration-300">
                계속하기
            </button>
        </div>
    </div>

    <!-- 보석 획득 화면 -->
    <div id="gemRewardScreen" class="fixed inset-0 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-1000 bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
        <div class="text-center max-w-4xl w-full px-4">
            <!-- 단일 보석 표시 (1회 뽑기용) -->
            <div id="singleReward" class="hidden">
                <div id="rewardGemImage" class="w-24 h-24 sm:w-32 sm:h-32 bg-yellow-400 rounded-full mx-auto mb-6 shadow-2xl flex items-center justify-center text-3xl sm:text-4xl">
                    💎
                </div>
                <div id="rewardText" class="text-4xl sm:text-6xl font-bold text-white mb-8 drop-shadow-2xl">1보석 획득!</div>
            </div>
            
            <!-- 다중 보석 표시 (10회 뽑기용) -->
            <div id="multipleReward" class="hidden">
                <div class="text-4xl sm:text-6xl font-bold text-white mb-8 drop-shadow-2xl">10개 보석 획득!</div>
                <div id="multipleGemGrid" class="grid grid-cols-5 gap-4 mb-8 max-w-2xl mx-auto">
                    <!-- 10개 보석이 여기에 표시됩니다 -->
                </div>
            </div>
            
            <button id="finalContinueBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-8 py-3 rounded-full text-white font-bold text-lg transition-all duration-300">
                확인
            </button>
        </div>
    </div>

    <!-- 상점 메인 화면 -->
    <div id="shopScreen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-500">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl w-11/12 max-w-md p-6">
            <!-- 상점 헤더 -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-white">🏪 상점</h2>
                <button id="closeShopBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                    ✕ 닫기
                </button>
            </div>
            
            <!-- 상점 메뉴 -->
            <div class="space-y-4">
                <button onclick="openGachaShop()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-6 py-4 rounded-xl text-white font-bold text-lg transition-all duration-300 flex items-center justify-center gap-3">
                    ⛏️ 원석 채굴장
                </button>
                <button onclick="openVolumeShop()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 px-6 py-4 rounded-xl text-white font-bold text-lg transition-all duration-300 flex items-center justify-center gap-3">
                    📦 볼륨 상점
                </button>
            </div>
        </div>
    </div>

    <!-- 원석 채굴장 화면 -->
    <div id="gachaShopScreen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-500">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl w-11/12 max-w-2xl max-h-[90vh] p-6 flex flex-col">
            <!-- 채굴장 헤더 -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-white">⛏️ 원석 채굴장</h2>
                <button id="closeGachaShopBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                    ✕ 닫기
                </button>
            </div>
            
            <!-- 뽑기 목록 (스크롤 가능) -->
            <div class="space-y-4 overflow-y-auto flex-1 pr-2" style="scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;">
                <style>
                    /* 웹킷 브라우저용 스크롤바 스타일 */
                    .space-y-4::-webkit-scrollbar {
                        width: 6px;
                    }
                    .space-y-4::-webkit-scrollbar-track {
                        background: rgba(255,255,255,0.1);
                        border-radius: 3px;
                    }
                    .space-y-4::-webkit-scrollbar-thumb {
                        background: rgba(255,255,255,0.3);
                        border-radius: 3px;
                    }
                    .space-y-4::-webkit-scrollbar-thumb:hover {
                        background: rgba(255,255,255,0.5);
                    }
                </style>
                <!-- 초심자의 원석 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-1">🪨 초심자의 원석</h3>
                        <p class="text-gray-300 text-sm">기본적인 보석이 나오는 원석입니다</p>
                        <p class="text-blue-300 font-medium">💰 10 포인트 | 💰 100 포인트 (10회)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startGacha('beginner')" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            1회 뽑기
                        </button>
                        <button onclick="startGacha('beginner', 10)" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            10회 뽑기
                        </button>
                    </div>
                </div>
                
                <!-- 빛나는 원석 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-1">✨ 빛나는 원석</h3>
                        <p class="text-gray-300 text-sm">균형잡힌 확률의 원석입니다</p>
                        <p class="text-purple-300 font-medium">💎 5 프리즘 | 💎 50 프리즘 (10회)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startGacha('normal')" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            1회 뽑기
                        </button>
                        <button onclick="startGacha('normal', 10)" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            10회 뽑기
                        </button>
                    </div>
                </div>
                
                <!-- 영롱한 원석 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-1">🌟 영롱한 원석</h3>
                        <p class="text-gray-300 text-sm">고급 보석이 더 잘 나오는 원석입니다</p>
                        <p class="text-purple-300 font-medium">💎 30 프리즘 | 💎 300 프리즘 (10회)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startGacha('premium')" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            1회 뽑기
                        </button>
                        <button onclick="startGacha('premium', 10)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            10회 뽑기
                        </button>
                    </div>
                </div>
                
                <!-- 광안의 원석 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-1">💫 광안의 원석</h3>
                        <p class="text-gray-300 text-sm">최고급 보석이 특별한 확률로 나오는 원석입니다</p>
                        <p class="text-purple-300 font-medium">💎 40 프리즘 | 💎 400 프리즘 (10회)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startGacha('luxury')" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            1회 뽑기
                        </button>
                        <button onclick="startGacha('luxury', 10)" class="bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            10회 뽑기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 볼륨 상점 화면 -->
    <div id="volumeShopScreen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-500">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl w-11/12 max-w-2xl p-6">
            <!-- 볼륨 상점 헤더 -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-white">📦 볼륨 상점</h2>
                <button id="closeVolumeShopBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                    ✕ 닫기
                </button>
            </div>
            
            <!-- 볼륨 목록 -->
            <div class="space-y-4">
                <!-- 멀티 볼륨 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-white mb-1">🔢 멀티 볼륨</h3>
                            <p class="text-gray-300 text-sm mb-2">장착한 보석의 배율을 합연산으로 더해줍니다</p>
                            <p class="text-blue-300 font-medium">💰 100,000 포인트</p>
                            <p id="multiVolumeStatus" class="text-xs text-gray-400 mt-1">미보유</p>
                        </div>
                        <button id="buyMultiVolumeBtn" onclick="buyVolume('multi')" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            구매
                        </button>
                    </div>
                </div>
                
                <!-- 코러스 볼륨 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-white mb-1">🎵 코러스 볼륨</h3>
                            <p class="text-gray-300 text-sm mb-2">장착한 보석의 코러스를 더해줍니다</p>
                            <p class="text-blue-300 font-medium">💰 55,000 포인트</p>
                            <p id="chorusVolumeStatus" class="text-xs text-gray-400 mt-1">미보유</p>
                        </div>
                        <button id="buyChorusVolumeBtn" onclick="buyVolume('chorus')" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            구매
                        </button>
                    </div>
                </div>
                
                <!-- 럭스 볼륨 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-white mb-1">✨ 럭스 볼륨</h3>
                            <p class="text-gray-300 text-sm mb-2">장착한 보석의 휘광 확률을 더해줍니다</p>
                            <p class="text-purple-300 font-medium">💎 100 프리즘 + 전설 이상 보석 1개</p>
                            <p id="luxVolumeStatus" class="text-xs text-gray-400 mt-1">미보유</p>
                        </div>
                        <button id="buyLuxVolumeBtn" onclick="buyVolume('lux')" class="bg-gradient-to-r from-yellow-400 to-pink-500 hover:from-yellow-500 hover:to-pink-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                            구매
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 설정 화면 -->
    <div id="settingsScreen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-500">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl w-11/12 max-w-md p-6">
            <!-- 설정 헤더 -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-white">⚙️ 설정</h2>
                <button id="closeSettingsBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                    ✕ 닫기
                </button>
            </div>
            
            <!-- 설정 옵션들 -->
            <div class="space-y-4">
                <!-- 수동 저장 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-white mb-2">💾 게임 저장</h3>
                    <p class="text-gray-300 text-sm mb-3">게임이 자동으로 저장되지만, 수동으로도 저장할 수 있습니다.</p>
                    <button onclick="saveGameData(); showMessage('게임이 저장되었습니다!', 'text-green-300')" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                        저장하기
                    </button>
                </div>
                
                <!-- 데이터 초기화 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-white mb-2">🗑️ 데이터 초기화</h3>
                    <p class="text-gray-300 text-sm mb-3">모든 게임 데이터를 삭제하고 처음부터 시작합니다.</p>
                    <button onclick="resetGameData()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                        초기화
                    </button>
                </div>
                
                <!-- 저장 정보 -->
                <div class="bg-white bg-opacity-5 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-white mb-2">📊 저장 정보</h3>
                    <div id="saveInfo" class="text-gray-300 text-sm">
                        <p>• 데이터는 브라우저에 자동 저장됩니다</p>
                        <p>• 브라우저 데이터를 삭제하면 게임 데이터도 사라집니다</p>
                        <p>• 같은 브라우저에서만 데이터가 유지됩니다</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 인벤토리 화면 -->
    <div id="inventoryScreen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-500">
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl w-11/12 max-w-4xl h-5/6 max-h-96 sm:max-h-screen sm:h-4/5 p-6 flex flex-col">
            <!-- 인벤토리 헤더 -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-white">🎒 인벤토리</h2>
                <button id="closeInventoryBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">
                    ✕ 닫기
                </button>
            </div>
            
            <!-- 인벤토리 내용 -->
            <div class="flex flex-1 gap-6 overflow-hidden">
                <!-- 좌측: 보석 리스트 -->
                <div class="w-1/2 bg-white bg-opacity-5 rounded-xl p-4 overflow-y-auto">
                    <h3 class="text-lg font-bold text-white mb-4">보석 목록</h3>
                    <div id="gemList" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                        <!-- 보석들이 여기에 동적으로 추가됩니다 -->
                    </div>
                </div>
                
                <!-- 우측: 보석 상세 정보 및 장착 슬롯 -->
                <div class="w-1/2 bg-white bg-opacity-5 rounded-xl p-4 overflow-y-auto">
                    <!-- 장착 슬롯 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-white mb-3">장착 슬롯</h3>
                        <div id="equipmentSlots" class="grid grid-cols-2 gap-2 mb-4">
                            <!-- 장착 슬롯들이 여기에 동적으로 추가됩니다 -->
                        </div>
                        <div class="text-xs text-gray-400">
                            <span id="slotInfo">슬롯 1/1 사용 중</span>
                        </div>
                    </div>
                    
                    <!-- 보석 상세 정보 -->
                    <div id="gemDetails" class="text-center text-white">
                        <div class="text-6xl mb-4">💎</div>
                        <h3 class="text-xl font-bold mb-2">보석을 선택하세요</h3>
                        <p class="text-gray-300">좌측에서 보석을 클릭하면 상세 정보가 표시됩니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let points = 0;
        let prisms = 0;
        let gems = 0; // 보석 별도 관리
        let chorus = 1;
        let multiple = 1;
        let isGachaActive = false; // 뽑기 진행 중 상태 관리
        let inventory = {}; // 인벤토리 객체 (보석ID: 개수)
        let equippedGems = []; // 장착된 보석 ID 배열 (다중 장착)
        let currentGachaResults = []; // 10회 뽑기 결과 저장
        
        // 볼륨 시스템
        let volumes = {
            multi: false,    // 멀티 볼륨 보유 여부
            chorus: false,   // 코러스 볼륨 보유 여부
            lux: false       // 럭스 볼륨 보유 여부
        };
        let maxSlots = 1; // 최대 장착 슬롯 수

        const pointsDisplay = document.getElementById('points');
        const prismsDisplay = document.getElementById('prisms');
        const earnPointsBtn = document.getElementById('earnPointsBtn');
        const shopBtn = document.getElementById('shopBtn');
        const inventoryBtn = document.getElementById('inventoryBtn');
        const messageDiv = document.getElementById('message');

        // 보석 데이터 (유지보수 쉽게 하기 위해 별도 객체로 관리)
        const gemData = {
            1: { name: '작은 수정', emoji: '💎', chorus: 1, multiple: 1, description: '작고 투명한 수정입니다.' },
            2: { name: '푸른 수정', emoji: '🔷', chorus: 2, multiple: 1, description: '푸른빛이 도는 아름다운 수정입니다.' },
            3: { name: '붉은 수정', emoji: '🔶', chorus: 3, multiple: 1, description: '붉은빛이 도는 화려한 수정입니다.' },
            4: { name: '에메랄드', emoji: '💚', chorus: 4, multiple: 1, description: '신비로운 녹색 보석입니다.' },
            5: { name: '사파이어', emoji: '💙', chorus: 5, multiple: 1, description: '깊은 파란색의 고급 보석입니다.' },
            6: { name: '루비', emoji: '❤️', chorus: 6, multiple: 1, description: '정열적인 빨간색 보석입니다.' },
            7: { name: '자수정', emoji: '💜', chorus: 7, multiple: 1.1, description: '고귀한 보라색 보석입니다.' },
            8: { name: '황금석', emoji: '💛', chorus: 8, multiple: 1.2, description: '황금빛으로 빛나는 보석입니다.' },
            9: { name: '다이아몬드', emoji: '💍', chorus: 9, multiple: 1.3, description: '가장 단단하고 빛나는 보석입니다.' },
            10: { name: '오팔', emoji: '🌈', chorus: 10, multiple: 1.4, lux: 0.5, description: '무지개빛으로 변하는 신비한 보석입니다.' },
            11: { name: '진주', emoji: '🤍', chorus: 11, multiple: 1.5, lux: 0.8, description: '바다에서 온 순백의 보석입니다.' },
            12: { name: '토파즈', emoji: '🧡', chorus: 12, multiple: 1.6, lux: 1.0, description: '따뜻한 주황빛의 보석입니다.' },
            13: { name: '별의 조각', emoji: '⭐', chorus: 15, multiple: 2.0, lux: 2.5, description: '하늘에서 떨어진 별의 조각입니다.' },
            14: { name: '달의 눈물', emoji: '🌙', chorus: 20, multiple: 2.5, lux: 4.0, description: '달빛이 응축된 신비한 보석입니다.' },
            15: { name: '태양의 심장', emoji: '☀️', chorus: 25, multiple: 3.0, lux: 5.0, description: '태양의 힘이 담긴 전설의 보석입니다.' }
        };

        // 보석 등급 확인 함수
        function getGemGrade(gemId) {
            for (const [grade, gemIds] of Object.entries(gemRewards)) {
                if (gemIds.includes(parseInt(gemId))) {
                    return grade;
                }
            }
            return '일반'; // 기본값
        }

        // 화면 업데이트 함수
        function updateDisplay() {
            pointsDisplay.textContent = points;
            prismsDisplay.textContent = prisms;
        }

        // 메시지 표시 함수
        function showMessage(text, color = 'text-white') {
            messageDiv.textContent = text;
            messageDiv.className = `mt-8 text-center font-medium text-lg transition-opacity duration-300 ${color}`;
            messageDiv.style.opacity = '1';
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
            }, 2000);
        }

        // 포인트 획득 버튼 클릭
        earnPointsBtn.addEventListener('click', () => {
            if (isGachaActive) return; // 뽑기 진행 중이면 무시
            
            const earnedPoints = Math.round((1 + chorus) * multiple);
            points += earnedPoints;
            
            // 휘광 체크
            if (window.totalLux > 0) {
                if (Math.random() * 100 < window.totalLux) {
                    prisms += 1;
                    updateDisplay();
                    autoSave(); // 자동 저장
                    showMessage(`${earnedPoints} 포인트 + 휘광으로 프리즘 1개 획득!`, 'text-purple-300');
                    return;
                }
            }
            
            updateDisplay();
            autoSave(); // 자동 저장
            showMessage(`${earnedPoints} 포인트를 획득했습니다!`, 'text-blue-300');
        });

        // 상점 버튼 클릭
        shopBtn.addEventListener('click', () => {
            if (isGachaActive) return; // 뽑기 진행 중이면 무시
            openShop();
        });

        // 인벤토리 버튼 클릭
        inventoryBtn.addEventListener('click', () => {
            if (isGachaActive) return; // 뽑기 진행 중이면 무시
            openInventory();
        });

        // 설정 버튼 클릭
        document.getElementById('settingsBtn').addEventListener('click', () => {
            if (isGachaActive) return; // 뽑기 진행 중이면 무시
            openSettings();
        });

        // 상점 열기
        function openShop() {
            const shopScreen = document.getElementById('shopScreen');
            shopScreen.style.opacity = '1';
            shopScreen.style.pointerEvents = 'auto';
        }

        // 상점 닫기
        document.getElementById('closeShopBtn').addEventListener('click', () => {
            const shopScreen = document.getElementById('shopScreen');
            shopScreen.style.opacity = '0';
            shopScreen.style.pointerEvents = 'none';
        });

        // 원석 채굴장 열기
        function openGachaShop() {
            const shopScreen = document.getElementById('shopScreen');
            const gachaShopScreen = document.getElementById('gachaShopScreen');
            
            shopScreen.style.opacity = '0';
            shopScreen.style.pointerEvents = 'none';
            
            setTimeout(() => {
                gachaShopScreen.style.opacity = '1';
                gachaShopScreen.style.pointerEvents = 'auto';
            }, 300);
        }

        // 원석 채굴장 닫기
        document.getElementById('closeGachaShopBtn').addEventListener('click', () => {
            const gachaShopScreen = document.getElementById('gachaShopScreen');
            gachaShopScreen.style.opacity = '0';
            gachaShopScreen.style.pointerEvents = 'none';
        });

        // 볼륨 상점 열기
        function openVolumeShop() {
            const shopScreen = document.getElementById('shopScreen');
            const volumeShopScreen = document.getElementById('volumeShopScreen');
            
            shopScreen.style.opacity = '0';
            shopScreen.style.pointerEvents = 'none';
            
            setTimeout(() => {
                volumeShopScreen.style.opacity = '1';
                volumeShopScreen.style.pointerEvents = 'auto';
                updateVolumeShopDisplay();
            }, 300);
        }

        // 볼륨 상점 닫기
        document.getElementById('closeVolumeShopBtn').addEventListener('click', () => {
            const volumeShopScreen = document.getElementById('volumeShopScreen');
            volumeShopScreen.style.opacity = '0';
            volumeShopScreen.style.pointerEvents = 'none';
        });

        // 인벤토리 열기
        function openInventory() {
            const inventoryScreen = document.getElementById('inventoryScreen');
            inventoryScreen.style.opacity = '1';
            inventoryScreen.style.pointerEvents = 'auto';
            updateInventoryDisplay();
            
            // 첫 번째 보석이 있으면 자동으로 선택하여 상세 정보 표시
            const firstGemId = Object.keys(inventory)[0];
            if (firstGemId) {
                showGemDetails(firstGemId);
            }
        }

        // 인벤토리 닫기
        document.getElementById('closeInventoryBtn').addEventListener('click', () => {
            const inventoryScreen = document.getElementById('inventoryScreen');
            inventoryScreen.style.opacity = '0';
            inventoryScreen.style.pointerEvents = 'none';
        });

        // 설정 열기
        function openSettings() {
            const settingsScreen = document.getElementById('settingsScreen');
            settingsScreen.style.opacity = '1';
            settingsScreen.style.pointerEvents = 'auto';
        }

        // 설정 닫기
        document.getElementById('closeSettingsBtn').addEventListener('click', () => {
            const settingsScreen = document.getElementById('settingsScreen');
            settingsScreen.style.opacity = '0';
            settingsScreen.style.pointerEvents = 'none';
        });

        // 볼륨 상점 화면 업데이트
        function updateVolumeShopDisplay() {
            // 멀티 볼륨 상태 업데이트
            const multiStatus = document.getElementById('multiVolumeStatus');
            const multiBtn = document.getElementById('buyMultiVolumeBtn');
            if (volumes.multi) {
                multiStatus.textContent = '보유 중';
                multiStatus.className = 'text-xs text-green-400 mt-1';
                multiBtn.textContent = '보유 중';
                multiBtn.disabled = true;
                multiBtn.className = 'bg-gray-500 px-4 py-2 rounded-full text-white font-bold opacity-50 cursor-not-allowed';
            }

            // 코러스 볼륨 상태 업데이트
            const chorusStatus = document.getElementById('chorusVolumeStatus');
            const chorusBtn = document.getElementById('buyChorusVolumeBtn');
            if (volumes.chorus) {
                chorusStatus.textContent = '보유 중';
                chorusStatus.className = 'text-xs text-green-400 mt-1';
                chorusBtn.textContent = '보유 중';
                chorusBtn.disabled = true;
                chorusBtn.className = 'bg-gray-500 px-4 py-2 rounded-full text-white font-bold opacity-50 cursor-not-allowed';
            }

            // 럭스 볼륨 상태 업데이트
            const luxStatus = document.getElementById('luxVolumeStatus');
            const luxBtn = document.getElementById('buyLuxVolumeBtn');
            if (volumes.lux) {
                luxStatus.textContent = '보유 중';
                luxStatus.className = 'text-xs text-green-400 mt-1';
                luxBtn.textContent = '보유 중';
                luxBtn.disabled = true;
                luxBtn.className = 'bg-gray-500 px-4 py-2 rounded-full text-white font-bold opacity-50 cursor-not-allowed';
            }
        }

        // 볼륨 구매 함수
        function buyVolume(type) {
            if (volumes[type]) {
                showMessage('이미 보유하고 있는 볼륨입니다!', 'text-yellow-300');
                return;
            }

            let canBuy = false;
            let cost = '';

            switch(type) {
                case 'multi':
                    if (points >= 100000) {
                        points -= 100000;
                        canBuy = true;
                        cost = '100,000 포인트';
                    }
                    break;
                case 'chorus':
                    if (points >= 55000) {
                        points -= 55000;
                        canBuy = true;
                        cost = '55,000 포인트';
                    }
                    break;
                case 'lux':
                    // 전설 이상 보석 확인
                    const legendaryGems = [];
                    Object.keys(inventory).forEach(gemId => {
                        const grade = getGemGrade(gemId);
                        if ((grade === '전설' || grade === '유니크') && inventory[gemId] >= 2) {
                            legendaryGems.push(gemId);
                        }
                    });

                    if (prisms >= 100 && legendaryGems.length > 0) {
                        // 사용자가 보석을 선택하도록 함
                        const selectedGemId = selectLegendaryGemForLux(legendaryGems);
                        if (selectedGemId) {
                            prisms -= 100;
                            inventory[selectedGemId]--;
                            canBuy = true;
                            const selectedGem = gemData[selectedGemId];
                            cost = `100 프리즘 + ${selectedGem.name} 1개`;
                        } else {
                            return; // 사용자가 취소한 경우
                        }
                    } else {
                        if (prisms < 100) {
                            showMessage('프리즘이 부족합니다! (100 프리즘 필요)', 'text-red-300');
                        } else {
                            showMessage('전설 이상 보석이 2개 이상 필요합니다!', 'text-red-300');
                        }
                        return;
                    }
                    break;
            }

            if (canBuy) {
                volumes[type] = true;
                maxSlots++;
                updateDisplay();
                updateVolumeShopDisplay();
                autoSave();
                showMessage(`${getVolumeKoreanName(type)}을(를) 구매했습니다! (${cost})`, 'text-green-300');
            } else {
                showMessage('재화가 부족합니다!', 'text-red-300');
            }
        }

        // 볼륨 한국어 이름 반환
        function getVolumeKoreanName(type) {
            switch(type) {
                case 'multi': return '멀티 볼륨';
                case 'chorus': return '코러스 볼륨';
                case 'lux': return '럭스 볼륨';
                default: return '볼륨';
            }
        }

        // 럭스 볼륨용 전설 보석 선택 함수
        function selectLegendaryGemForLux(legendaryGems) {
            let message = '럭스 볼륨 구매에 사용할 보석을 선택하세요:\n\n';
            legendaryGems.forEach((gemId, index) => {
                const gem = gemData[gemId];
                const count = inventory[gemId];
                message += `${index + 1}. ${gem.name} (${count}개 보유)\n`;
            });
            message += '\n번호를 입력하세요 (취소하려면 0):';
            
            const choice = prompt(message);
            const choiceNum = parseInt(choice);
            
            if (choiceNum >= 1 && choiceNum <= legendaryGems.length) {
                return legendaryGems[choiceNum - 1];
            }
            
            return null; // 취소 또는 잘못된 입력
        }

        // 볼륨 상점 버튼 상태 초기화
        function resetVolumeShopButtons() {
            // 멀티 볼륨 버튼 초기화
            const multiStatus = document.getElementById('multiVolumeStatus');
            const multiBtn = document.getElementById('buyMultiVolumeBtn');
            multiStatus.textContent = '미보유';
            multiStatus.className = 'text-xs text-gray-400 mt-1';
            multiBtn.textContent = '구매';
            multiBtn.disabled = false;
            multiBtn.className = 'bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300';

            // 코러스 볼륨 버튼 초기화
            const chorusStatus = document.getElementById('chorusVolumeStatus');
            const chorusBtn = document.getElementById('buyChorusVolumeBtn');
            chorusStatus.textContent = '미보유';
            chorusStatus.className = 'text-xs text-gray-400 mt-1';
            chorusBtn.textContent = '구매';
            chorusBtn.disabled = false;
            chorusBtn.className = 'bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-4 py-2 rounded-full text-white font-bold transition-all duration-300';

            // 럭스 볼륨 버튼 초기화
            const luxStatus = document.getElementById('luxVolumeStatus');
            const luxBtn = document.getElementById('buyLuxVolumeBtn');
            luxStatus.textContent = '미보유';
            luxStatus.className = 'text-xs text-gray-400 mt-1';
            luxBtn.textContent = '구매';
            luxBtn.disabled = false;
            luxBtn.className = 'bg-gradient-to-r from-yellow-400 to-pink-500 hover:from-yellow-500 hover:to-pink-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300';
        }

        // 인벤토리 화면 업데이트
        function updateInventoryDisplay() {
            const gemList = document.getElementById('gemList');
            gemList.innerHTML = '';

            Object.keys(inventory).forEach(gemId => {
                const gem = gemData[gemId];
                const count = inventory[gemId];
                const isEquipped = equippedGems.includes(parseInt(gemId));
                const gemElement = document.createElement('div');
                gemElement.className = `bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg p-3 cursor-pointer transition-all duration-300 text-center relative ${isEquipped ? 'ring-2 ring-yellow-400' : ''}`;
                gemElement.innerHTML = `
                    <div class="text-2xl mb-1">${gem.emoji}</div>
                    <div class="text-xs text-white">${gem.name}</div>
                    <div class="absolute top-1 right-1 bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${count}</div>
                    ${isEquipped ? '<div class="text-xs text-yellow-400 mt-1">장착됨</div>' : ''}
                `;
                gemElement.addEventListener('click', () => showGemDetails(gemId));
                gemList.appendChild(gemElement);
            });

            if (Object.keys(inventory).length === 0) {
                gemList.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">보석이 없습니다</div>';
            }

            // 장착 슬롯 업데이트
            updateEquipmentSlots();
        }

        // 장착 슬롯 업데이트
        function updateEquipmentSlots() {
            const equipmentSlots = document.getElementById('equipmentSlots');
            const slotInfo = document.getElementById('slotInfo');
            
            equipmentSlots.innerHTML = '';
            
            // 볼륨별 슬롯 표시
            const volumeTypes = [
                { key: 'multi', name: '멀티 볼륨', available: true }, // 기본 슬롯
                { key: 'multi', name: '멀티 볼륨', available: volumes.multi },
                { key: 'chorus', name: '코러스 볼륨', available: volumes.chorus },
                { key: 'lux', name: '럭스 볼륨', available: volumes.lux }
            ];
            
            for (let i = 0; i < maxSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'bg-white bg-opacity-10 rounded-lg p-3 text-center cursor-pointer hover:bg-opacity-20 transition-all duration-300';
                
                let volumeName = '기본 슬롯';
                if (i === 1 && volumes.multi) volumeName = '멀티 볼륨';
                else if (i === 2 && volumes.chorus) volumeName = '코러스 볼륨';
                else if (i === 3 && volumes.lux) volumeName = '럭스 볼륨';
                else if (i > 0) {
                    // 볼륨 순서대로 이름 할당
                    if (volumes.multi && i === 1) volumeName = '멀티 볼륨';
                    else if (volumes.chorus && ((volumes.multi && i === 2) || (!volumes.multi && i === 1))) volumeName = '코러스 볼륨';
                    else if (volumes.lux) {
                        let luxSlotIndex = 1;
                        if (volumes.multi) luxSlotIndex++;
                        if (volumes.chorus) luxSlotIndex++;
                        if (i === luxSlotIndex) volumeName = '럭스 볼륨';
                    }
                }
                
                if (equippedGems[i]) {
                    const gem = gemData[equippedGems[i]];
                    slot.innerHTML = `
                        <div class="text-xs text-blue-300 mb-1">${volumeName}</div>
                        <div class="text-2xl mb-1">${gem.emoji}</div>
                        <div class="text-xs text-white">${gem.name}</div>
                    `;
                    slot.onclick = () => unequipGemFromSlot(i);
                } else {
                    slot.innerHTML = `
                        <div class="text-xs text-blue-300 mb-1">${volumeName}</div>
                        <div class="text-2xl mb-1 opacity-50">💎</div>
                        <div class="text-xs text-gray-400">비어있음</div>
                    `;
                }
                
                equipmentSlots.appendChild(slot);
            }
            
            slotInfo.textContent = `슬롯 ${equippedGems.length}/${maxSlots} 사용 중`;
        }

        // 보석 상세 정보 표시
        function showGemDetails(gemId) {
            const gem = gemData[gemId];
            const gemDetails = document.getElementById('gemDetails');
            const count = inventory[gemId] || 0;
            
            // 스탯 텍스트 생성
            let statsText = `코러스 +${gem.chorus}`;
            if (gem.multiple > 1) {
                statsText += ` | x${gem.multiple}`;
            }
            if (gem.lux) {
                statsText += ` | 휘광 ${gem.lux}%`;
            }
            
            const isEquipped = equippedGems.includes(parseInt(gemId));
            const canExtract = count >= 2;
            const canEquip = !isEquipped && equippedGems.length < maxSlots;
            
            gemDetails.innerHTML = `
                <div class="text-6xl mb-4">${gem.emoji}</div>
                <h3 class="text-xl font-bold mb-2">${gem.name}</h3>
                <div class="text-blue-300 font-medium mb-2">${statsText}</div>
                <div class="text-gray-400 text-sm mb-4">보유 개수: ${count}개</div>
                <p class="text-gray-300 mb-4">${gem.description}</p>
                <div class="flex gap-2 justify-center flex-wrap">
                    ${isEquipped ? 
                        `<button onclick="unequipGem(${gemId})" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">장착 해제</button>` :
                        canEquip ? 
                            `<button onclick="equipGem(${gemId})" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">장착하기</button>` :
                            '<button class="bg-gray-500 px-4 py-2 rounded-full text-white font-bold opacity-50 cursor-not-allowed" disabled>슬롯 부족</button>'
                    }
                    ${canExtract ? 
                        `<button onclick="extractGem(${gemId})" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-full text-white font-bold transition-all duration-300">추출</button>` :
                        '<button class="bg-gray-500 px-4 py-2 rounded-full text-white font-bold opacity-50 cursor-not-allowed" disabled>추출 불가</button>'
                    }
                </div>
            `;
        }

        // 뽑기 시작 함수 (상점에서 호출)
        function startGacha(type, count = 1) {
            if (isGachaActive) return; // 뽑기 진행 중이면 무시
            
            let cost, currency, hasEnough;
            
            switch(type) {
                case 'beginner':
                    cost = count === 10 ? 100 : 10;
                    currency = 'points';
                    hasEnough = points >= cost;
                    break;
                case 'normal':
                    cost = count === 10 ? 50 : 5;
                    currency = 'prisms';
                    hasEnough = prisms >= cost;
                    break;
                case 'premium':
                    cost = count === 10 ? 300 : 30;
                    currency = 'prisms';
                    hasEnough = prisms >= cost;
                    break;
                case 'luxury':
                    cost = count === 10 ? 400 : 40;
                    currency = 'prisms';
                    hasEnough = prisms >= cost;
                    break;
            }
            
            if (hasEnough) {
                if (currency === 'points') {
                    points -= cost;
                } else {
                    prisms -= cost;
                }
                updateDisplay();
                autoSave(); // 자동 저장
                
                // 모든 상점 화면 닫기
                const shopScreen = document.getElementById('shopScreen');
                const gachaShopScreen = document.getElementById('gachaShopScreen');
                shopScreen.style.opacity = '0';
                shopScreen.style.pointerEvents = 'none';
                gachaShopScreen.style.opacity = '0';
                gachaShopScreen.style.pointerEvents = 'none';
                
                // 뽑기 타입과 횟수 저장하고 애니메이션 시작
                window.currentGachaType = type;
                window.currentGachaCount = count;
                startGachaAnimation();
            } else {
                const currencyName = currency === 'points' ? '포인트' : '프리즘';
                showMessage(`${currencyName}이 부족합니다! (${cost} ${currencyName} 필요)`, 'text-red-300');
            }
        }

        // 뽑기 애니메이션 시작
        function startGachaAnimation() {
            isGachaActive = true; // 뽑기 진행 상태로 변경
            
            const mainUI = document.getElementById('mainUI');
            const gachaScreen = document.getElementById('gachaScreen');
            const gemstone = document.getElementById('gemstone');
            const gachaText = document.getElementById('gachaText');
            
            // 메인 UI 숨기고 뽑기 화면 표시
            mainUI.style.opacity = '0';
            gachaScreen.style.opacity = '1';
            gachaScreen.style.pointerEvents = 'auto';
            
            // 텍스트 업데이트
            if (window.currentGachaCount === 10) {
                gachaText.textContent = '원석을 클릭하세요! (10회 뽑기)';
            } else {
                gachaText.textContent = '원석을 클릭하세요!';
            }
            
            // 원석 클릭 이벤트 (기존 이벤트 제거 후 새로 추가)
            gemstone.onclick = null;
            gemstone.onclick = () => {
                if (window.currentGachaCount === 10) {
                    performMultipleGacha();
                } else {
                    revealGrade();
                }
            };
        }

        // 등급별 보석 보상 설정 (유지보수 쉽게 하기 위해 별도 객체로 관리)
        // 새 보석을 추가할 때는 gemData에 먼저 추가하고, 여기서 해당 등급 배열에 ID를 추가하세요
        // 예시: 16번 보석을 전설 등급에 추가하려면 '전설': [10, 11, 12, 16] 이렇게 수정
        const gemRewards = {
            '일반': [1, 2, 3],
            '희귀': [4, 5, 6], 
            '에픽': [7, 8, 9],
            '전설': [10, 11, 12],
            '유니크': [13, 14, 15]
        };

        // 10회 뽑기 실행
        function performMultipleGacha() {
            currentGachaResults = [];
            
            // 10번 뽑기 실행
            for (let i = 0; i < 10; i++) {
                const result = performSingleGacha();
                currentGachaResults.push(result);
            }
            
            // 가장 높은 등급 찾기
            const gradeOrder = ['일반', '희귀', '에픽', '전설', '유니크'];
            let highestGrade = '일반';
            let highestGradeClass = 'grade-common';
            
            currentGachaResults.forEach(result => {
                const currentIndex = gradeOrder.indexOf(result.grade);
                const highestIndex = gradeOrder.indexOf(highestGrade);
                if (currentIndex > highestIndex) {
                    highestGrade = result.grade;
                    highestGradeClass = result.gradeClass;
                }
            });
            
            // 등급 공개 화면으로 이동 (가장 높은 등급만 표시)
            showGradeReveal(highestGrade, highestGradeClass, true);
        }

        // 단일 뽑기 실행 (내부 로직)
        function performSingleGacha() {
            // 뽑기 타입별 확률 설정
            let grades;
            switch(window.currentGachaType) {
                case 'beginner':
                    grades = [
                        { name: '일반', class: 'grade-common', probability: 0.7 },
                        { name: '희귀', class: 'grade-rare', probability: 0.2 },
                        { name: '에픽', class: 'grade-epic', probability: 0.08 },
                        { name: '전설', class: 'grade-legendary', probability: 0.015 },
                        { name: '유니크', class: 'grade-unique', probability: 0.005 }
                    ];
                    break;
                case 'normal':
                    grades = [
                        { name: '일반', class: 'grade-common', probability: 0.5 },
                        { name: '희귀', class: 'grade-rare', probability: 0.25 },
                        { name: '에픽', class: 'grade-epic', probability: 0.15 },
                        { name: '전설', class: 'grade-legendary', probability: 0.07 },
                        { name: '유니크', class: 'grade-unique', probability: 0.03 }
                    ];
                    break;
                case 'premium':
                    grades = [
                        { name: '일반', class: 'grade-common', probability: 0.3 },
                        { name: '희귀', class: 'grade-rare', probability: 0.3 },
                        { name: '에픽', class: 'grade-epic', probability: 0.25 },
                        { name: '전설', class: 'grade-legendary', probability: 0.1 },
                        { name: '유니크', class: 'grade-unique', probability: 0.05 }
                    ];
                    break;
                case 'luxury':
                    grades = [
                        { name: '일반', class: 'grade-common', probability: 0.3 },
                        { name: '희귀', class: 'grade-rare', probability: 0.3 },
                        { name: '에픽', class: 'grade-epic', probability: 0.25 },
                        { name: '전설', class: 'grade-legendary', probability: 0.1 },
                        { name: '유니크', class: 'grade-unique', probability: 0.05 }
                    ];
                    break;
                default:
                    grades = [
                        { name: '일반', class: 'grade-common', probability: 0.5 },
                        { name: '희귀', class: 'grade-rare', probability: 0.25 },
                        { name: '에픽', class: 'grade-epic', probability: 0.15 },
                        { name: '전설', class: 'grade-legendary', probability: 0.07 },
                        { name: '유니크', class: 'grade-unique', probability: 0.03 }
                    ];
            }

            // 확률에 따른 등급 결정
            const random = Math.random();
            let currentProbability = 0;
            let selectedGrade = grades[0];

            for (const grade of grades) {
                currentProbability += grade.probability;
                if (random <= currentProbability) {
                    selectedGrade = grade;
                    break;
                }
            }

            // 보석 선택
            let possibleRewards = gemRewards[selectedGrade.name];
            let selectedReward;
            
            // 광안의 원석 특별 확률 적용
            if (window.currentGachaType === 'luxury') {
                if (selectedGrade.name === '전설') {
                    const random = Math.random();
                    if (random < 0.6) {
                        selectedReward = 12; // 토파즈
                    } else {
                        selectedReward = possibleRewards[Math.floor(Math.random() * possibleRewards.length)];
                    }
                } else if (selectedGrade.name === '유니크') {
                    const random = Math.random();
                    if (random < 0.6) {
                        selectedReward = 15; // 태양의 심장
                    } else {
                        selectedReward = possibleRewards[Math.floor(Math.random() * possibleRewards.length)];
                    }
                } else {
                    selectedReward = possibleRewards[Math.floor(Math.random() * possibleRewards.length)];
                }
            } else {
                selectedReward = possibleRewards[Math.floor(Math.random() * possibleRewards.length)];
            }

            return {
                grade: selectedGrade.name,
                gradeClass: selectedGrade.class,
                gemId: selectedReward
            };
        }

        // 등급 결정 및 공개 (1회 뽑기용)
        function revealGrade() {
            const result = performSingleGacha();
            window.currentGrade = result.grade;
            window.currentGemId = result.gemId;
            
            showGradeReveal(result.grade, result.gradeClass, false);
        }

        // 등급 공개 화면 표시
        function showGradeReveal(gradeName, gradeClass, isMultiple) {
            const gachaScreen = document.getElementById('gachaScreen');
            const revealScreen = document.getElementById('revealScreen');
            const gradeText = document.getElementById('gradeText');
            const revealMessage = document.getElementById('revealMessage');

            // 뽑기 화면 숨기기
            gachaScreen.style.opacity = '0';
            gachaScreen.style.pointerEvents = 'none';

            // 등급 공개 화면 표시
            setTimeout(() => {
                revealScreen.style.opacity = '1';
                revealScreen.style.pointerEvents = 'auto';
                revealScreen.className = `fixed inset-0 flex items-center justify-center z-50 transition-all duration-1000 ${gradeClass}`;
                gradeText.textContent = gradeName;
                
                if (isMultiple) {
                    revealMessage.textContent = `최고 등급: ${gradeName}!`;
                } else {
                    revealMessage.textContent = '등급이 공개되었습니다!';
                }
            }, 500);
        }

        // 계속하기 버튼 (등급 공개 -> 보석 획득 화면으로)
        document.getElementById('continueBtn').addEventListener('click', () => {
            if (window.currentGachaCount === 10) {
                showMultipleGemReward();
            } else {
                showSingleGemReward();
            }
        });

        // 단일 보석 획득 화면 표시
        function showSingleGemReward() {
            const revealScreen = document.getElementById('revealScreen');
            const gemRewardScreen = document.getElementById('gemRewardScreen');
            const singleReward = document.getElementById('singleReward');
            const multipleReward = document.getElementById('multipleReward');
            const rewardText = document.getElementById('rewardText');
            const rewardGemImage = document.getElementById('rewardGemImage');
            
            // 인벤토리에 보석 추가
            if (inventory[window.currentGemId]) {
                inventory[window.currentGemId]++;
            } else {
                inventory[window.currentGemId] = 1;
            }
            autoSave(); // 자동 저장
            
            // 보석 이미지와 텍스트 업데이트
            const gem = gemData[window.currentGemId];
            rewardGemImage.innerHTML = gem.emoji;
            rewardGemImage.className = 'w-24 h-24 sm:w-32 sm:h-32 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full mx-auto mb-6 shadow-2xl flex items-center justify-center text-3xl sm:text-4xl';
            rewardText.textContent = `${gem.name} 획득!`;
            
            // 단일 보석 표시 모드
            singleReward.classList.remove('hidden');
            multipleReward.classList.add('hidden');
            
            // 등급 공개 화면 숨기기
            revealScreen.style.opacity = '0';
            revealScreen.style.pointerEvents = 'none';
            
            // 보석 획득 화면 표시
            setTimeout(() => {
                gemRewardScreen.style.opacity = '1';
                gemRewardScreen.style.pointerEvents = 'auto';
            }, 500);
        }

        // 다중 보석 획득 화면 표시
        function showMultipleGemReward() {
            const revealScreen = document.getElementById('revealScreen');
            const gemRewardScreen = document.getElementById('gemRewardScreen');
            const singleReward = document.getElementById('singleReward');
            const multipleReward = document.getElementById('multipleReward');
            const multipleGemGrid = document.getElementById('multipleGemGrid');
            
            // 인벤토리에 모든 보석 추가
            currentGachaResults.forEach(result => {
                if (inventory[result.gemId]) {
                    inventory[result.gemId]++;
                } else {
                    inventory[result.gemId] = 1;
                }
            });
            autoSave(); // 자동 저장
            
            // 10개 보석 그리드 생성
            multipleGemGrid.innerHTML = '';
            currentGachaResults.forEach(result => {
                const gem = gemData[result.gemId];
                const gemElement = document.createElement('div');
                gemElement.className = 'bg-white bg-opacity-10 rounded-lg p-3 text-center';
                gemElement.innerHTML = `
                    <div class="text-3xl mb-2">${gem.emoji}</div>
                    <div class="text-xs text-white">${gem.name}</div>
                `;
                multipleGemGrid.appendChild(gemElement);
            });
            
            // 다중 보석 표시 모드
            singleReward.classList.add('hidden');
            multipleReward.classList.remove('hidden');
            
            // 등급 공개 화면 숨기기
            revealScreen.style.opacity = '0';
            revealScreen.style.pointerEvents = 'none';
            
            // 보석 획득 화면 표시
            setTimeout(() => {
                gemRewardScreen.style.opacity = '1';
                gemRewardScreen.style.pointerEvents = 'auto';
            }, 500);
        }

        // 최종 확인 버튼 (보석 획득 화면 -> 메인 UI로)
        document.getElementById('finalContinueBtn').addEventListener('click', () => {
            const mainUI = document.getElementById('mainUI');
            const revealScreen = document.getElementById('revealScreen');
            const gemRewardScreen = document.getElementById('gemRewardScreen');
            
            // 보석 획득 화면 숨기기
            gemRewardScreen.style.opacity = '0';
            gemRewardScreen.style.pointerEvents = 'none';
            
            // 메인 UI 다시 표시
            setTimeout(() => {
                mainUI.style.opacity = '1';
                isGachaActive = false; // 뽑기 완료 상태로 변경
                
                // 결과 초기화
                currentGachaResults = [];
                window.currentGachaCount = 1;
            }, 300);
            
            // 모든 화면 완전히 초기화
            setTimeout(() => {
                revealScreen.className = 'fixed inset-0 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-all duration-1000';
                revealScreen.style.background = '';
                revealScreen.style.animation = '';
                gemRewardScreen.style.opacity = '0';
                gemRewardScreen.style.pointerEvents = 'none';
            }, 1000);
        });

        // 보석 장착 함수
        function equipGem(gemId) {
            if (equippedGems.length >= maxSlots) {
                showMessage('장착 슬롯이 부족합니다!', 'text-red-300');
                return;
            }
            
            if (equippedGems.includes(parseInt(gemId))) {
                showMessage('이미 장착된 보석입니다!', 'text-yellow-300');
                return;
            }
            
            equippedGems.push(parseInt(gemId));
            const gem = gemData[gemId];
            
            // 스탯 재계산
            calculateTotalStats();
            updateEquippedGemDisplay();
            updateInventoryDisplay(); // 인벤토리 화면 새로고침
            showGemDetails(gemId); // 상세 정보 즉시 업데이트
            autoSave(); // 자동 저장
            showMessage(`${gem.name}을(를) 장착했습니다!`, 'text-green-300');
        }

        // 보석 장착 해제 함수 (특정 보석)
        function unequipGem(gemId) {
            const index = equippedGems.indexOf(parseInt(gemId));
            if (index > -1) {
                equippedGems.splice(index, 1);
                calculateTotalStats();
                updateEquippedGemDisplay();
                updateInventoryDisplay();
                showGemDetails(gemId);
                autoSave();
                showMessage('보석 장착을 해제했습니다!', 'text-yellow-300');
            }
        }

        // 슬롯에서 보석 해제 함수
        function unequipGemFromSlot(slotIndex) {
            if (equippedGems[slotIndex]) {
                const gemId = equippedGems[slotIndex];
                equippedGems.splice(slotIndex, 1);
                calculateTotalStats();
                updateEquippedGemDisplay();
                updateInventoryDisplay();
                autoSave();
                showMessage('보석 장착을 해제했습니다!', 'text-yellow-300');
            }
        }

        // 전체 스탯 계산 함수
        function calculateTotalStats() {
            let totalChorus = 0;
            let totalMultiple = 0;
            let totalLux = 0;
            
            equippedGems.forEach(gemId => {
                const gem = gemData[gemId];
                if (gem) {
                    // 코러스 계산
                    if (volumes.chorus) {
                        totalChorus += gem.chorus;
                    } else {
                        totalChorus = Math.max(totalChorus, gem.chorus); // 코러스 볼륨이 없으면 최대값만
                    }
                    
                    // 배율 계산
                    if (volumes.multi) {
                        totalMultiple += (gem.multiple - 1); // 합연산 (1.2 + 1.3 = 1.5)
                    } else {
                        totalMultiple = Math.max(totalMultiple, gem.multiple - 1); // 멀티 볼륨이 없으면 최대값만
                    }
                    
                    // 휘광 계산
                    if (volumes.lux && gem.lux) {
                        totalLux += gem.lux;
                    } else if (gem.lux) {
                        totalLux = Math.max(totalLux, gem.lux); // 럭스 볼륨이 없으면 최대값만
                    }
                }
            });
            
            // 기본값 설정
            chorus = Math.max(1, totalChorus);
            multiple = 1 + totalMultiple;
            
            // 휘광은 별도로 계산 (포인트 획득 시 사용)
            window.totalLux = totalLux;
        }

        // 보석 추출 함수
        function extractGem(gemId) {
            const gem = gemData[gemId];
            const count = inventory[gemId];
            
            if (count >= 2) {
                inventory[gemId]--;
                
                // 보석 등급별 프리즘 획득량 설정
                const grade = getGemGrade(gemId);
                let prismReward;
                switch(grade) {
                    case '일반': prismReward = 1; break;
                    case '희귀': prismReward = 3; break;
                    case '에픽': prismReward = 8; break;
                    case '전설': prismReward = 20; break;
                    case '유니크': prismReward = 60; break;
                    default: prismReward = 1; break;
                }
                
                prisms += prismReward;
                updateDisplay();
                updateInventoryDisplay();
                showGemDetails(gemId); // 상세 정보 새로고침
                autoSave(); // 자동 저장
                showMessage(`${gem.name}을(를) 추출하여 프리즘 ${prismReward}개를 획득했습니다!`, 'text-purple-300');
            }
        }

        // 장착된 보석 표시 업데이트
        function updateEquippedGemDisplay() {
            const equippedGemDisplay = document.getElementById('equippedGemDisplay');
            const equippedGemIcon = document.getElementById('equippedGemIcon');
            const equippedGemName = document.getElementById('equippedGemName');
            const equippedGemStats = document.getElementById('equippedGemStats');

            if (equippedGems.length > 0) {
                // 여러 보석이 장착된 경우 첫 번째 보석 정보 표시하고 개수 표시
                const firstGem = gemData[equippedGems[0]];
                
                if (equippedGems.length === 1) {
                    equippedGemIcon.textContent = firstGem.emoji;
                    equippedGemName.textContent = firstGem.name;
                } else {
                    equippedGemIcon.textContent = '💎';
                    equippedGemName.textContent = `${equippedGems.length}개 장착됨`;
                }
                
                let statsText = `코러스 +${chorus}`;
                if (multiple > 1) {
                    statsText += ` | x${multiple.toFixed(1)}`;
                }
                if (window.totalLux > 0) {
                    statsText += ` | 휘광 ${window.totalLux.toFixed(1)}%`;
                }
                equippedGemStats.textContent = statsText;
                
                equippedGemDisplay.style.opacity = '1';
            } else {
                equippedGemDisplay.style.opacity = '0';
            }
        }

        // 로컬 저장소 관련 함수들
        function saveGameData() {
            const gameData = {
                points: points,
                prisms: prisms,
                inventory: inventory,
                equippedGems: equippedGems,
                volumes: volumes,
                maxSlots: maxSlots,
                chorus: chorus,
                multiple: multiple,
                lastSaved: Date.now()
            };
            localStorage.setItem('gemGachaGame', JSON.stringify(gameData));
        }

        function loadGameData() {
            try {
                const savedData = localStorage.getItem('gemGachaGame');
                if (savedData) {
                    const gameData = JSON.parse(savedData);
                    points = gameData.points || 0;
                    prisms = gameData.prisms || 0;
                    inventory = gameData.inventory || {};
                    equippedGems = gameData.equippedGems || [];
                    volumes = gameData.volumes || { multi: false, chorus: false, lux: false };
                    maxSlots = gameData.maxSlots || 1;
                    
                    // 스탯 재계산
                    calculateTotalStats();
                    
                    showMessage('저장된 게임 데이터를 불러왔습니다!', 'text-green-300');
                    return true;
                }
            } catch (error) {
                console.error('게임 데이터 로드 실패:', error);
                showMessage('저장된 데이터를 불러오는데 실패했습니다.', 'text-red-300');
            }
            return false;
        }

        function resetGameData() {
            if (confirm('정말로 게임 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                localStorage.removeItem('gemGachaGame');
                points = 0;
                prisms = 0;
                inventory = {};
                equippedGems = [];
                volumes = { multi: false, chorus: false, lux: false };
                maxSlots = 1;
                chorus = 1;
                multiple = 1;
                window.totalLux = 0;
                updateDisplay();
                updateEquippedGemDisplay();
                
                // 볼륨 상점 버튼 상태 초기화
                resetVolumeShopButtons();
                
                showMessage('게임 데이터가 초기화되었습니다.', 'text-yellow-300');
            }
        }

        // 게임 상태가 변경될 때마다 자동 저장
        function autoSave() {
            saveGameData();
        }

        // 초기 화면 업데이트 및 데이터 로드
        loadGameData();
        updateDisplay();
        updateEquippedGemDisplay();
        
        // 초기 스탯 계산 (로드된 데이터가 없는 경우)
        if (equippedGems.length === 0) {
            window.totalLux = 0;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977c1cfbd3d3d1d1',t:'MTc1NjYzODk2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
